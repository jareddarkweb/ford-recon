name: FFUF Subdomain Scan

on:
  workflow_dispatch:
  push:
    paths:
      - 'new_subdomains.txt'

jobs:
  fuzz:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '>=1.21'

      - name: Install FFUF
        run: |
          go install github.com/ffuf/ffuf/v2@latest
          echo "$(go env GOPATH)/bin" >> $GITHUB_PATH

      - name: Run FFUF Scan
        run: |
          # Check if the file exists to prevent failure
          if [ ! -f new_subdomains.txt ]; then
            echo "Error: new_subdomains.txt not found!"
            exit 1
          fi

          # 1. Pick 10 unique targets
          shuf -n 10 new_subdomains.txt | sort -u > targets.txt
          
          echo "Scanning the following targets:"
          cat targets.txt
          
          # 2. Get wordlist
          curl -s https://raw.githubusercontent.com/danielmiessler/SecLists/master/Discovery/Web-Content/common.txt -o common.txt
          
          # 3. Loop and Scan
          while IFS= read -r line || [ -n "$line" ]; do
            [ -z "$line" ] && continue
            echo "---------------------------------------------------"
            echo "Starting scan on: $line"
            ffuf -u "https://$line/FUZZ" -w common.txt -mc 200,301,302 -t 50
          done < targets.txt
